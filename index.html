<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Web Development &amp; SEO Services in Tbilisi, Georgia | Digital Craft</title>
    <meta name="description" content="Loading professional web development and SEO services based in Tbilisi. We build high-performance websites for businesses.">
    
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        :root { --color-bg: #030409; --color-text: #FFFFFF; --color-accent: #b8d8e8; }
        body { margin: 0; padding: 0; background-color: var(--color-bg); color: var(--color-text); font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity 0.5s ease-out; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--color-accent); border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

    <link rel="stylesheet" href="/styles.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/styles.css"></noscript>
</head>
<body>
    <noscript>
        <div><img src="https://mc.yandex.ru/watch/103413242" style="position:absolute; left:-9999px;" alt=""></div>
        <h1>Digital Craft - Web Development &amp; SEO in Tbilisi</h1>
        <p>We create professional, high-performance websites and provide SEO services for small and medium businesses in Tbilisi, Georgia. Contact us for a consultation.</p>
        <a href="/en/services/web-development">Web Development</a>
        <a href="/en/portfolio/example-project">Our Portfolio</a>
    </noscript>

    <div id="loader"><div class="spinner"></div></div>
    <iframe id="custom-background-iframe" title="Custom Background"></iframe>
    <button class="menu-toggle" aria-label="Toggle menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
    <div class="nav-overlay"><ul class="nav-menu"></ul></div>
    <main></main>
    <footer class="site-footer" id="site-footer"></footer>
    <div id="admin-panel">
        <div class="admin-container">
            <div class="admin-sidebar">
                <h3>Admin Panel</h3>
                <ul class="admin-tabs">
                    <li class="admin-tab active" data-tab="home">Home Page</li>
                    <li class="admin-tab" data-tab="services">Services</li>
                    <li class="admin-tab" data-tab="portfolio">Portfolio</li>
                    <li class="admin-tab" data-tab="blog">Blog</li>
                    <li class="admin-tab" data-tab="contact">Contact</li>
                </ul>
            </div>
            <div class="admin-content">
                <button id="admin-close-btn" title="Close Admin Panel">×</button>
                <div class="tab-content active" data-tab-content="home"></div>
                <div class="tab-content" data-tab-content="services"></div>
                <div class="tab-content" data-tab-content="portfolio"></div>
                <div class="tab-content" data-tab-content="blog"></div>
                <div class="tab-content" data-tab-content="contact"></div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- FIREBASE & INITIALIZATION ---
        const firebaseConfig = { apiKey: "AIzaSyAT4dDEIDUtzP60ibjahO06P75Q6h95ZN4", authDomain: "razrabotka-b61bc.firebaseapp.com", projectId: "razrabotka-b61bc", storageBucket: "razrabotka-b61bc.firebasestorage.app", messagingSenderId: "394402564794", appId: "1:394402564794:web:f610ffb03e655c600c5083" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let siteData = {}; // Global cache for all site data

        // --- CORE DATA FUNCTION ---
        async function loadData() {
            if (Object.keys(siteData).length > 0) return siteData;
            try {
                const collections = ['services', 'portfolio', 'blog', 'contact'];
                const dataPromises = [db.collection('home').doc('content').get(), ...collections.map(col => db.collection(col).get())];
                const [homeDoc, ...snapshots] = await Promise.all(dataPromises);
                const freshSiteData = {};
                const processDocData = (data) => { if (data && typeof data.schemaJsonLd === 'string' && data.schemaJsonLd.trim().startsWith('{')) { try { data.schemaJsonLd = JSON.parse(data.schemaJsonLd); } catch (e) { console.error('Failed to parse schemaJsonLd string:', e); data.schemaJsonLd = {}; } } return data; };
                freshSiteData.home = homeDoc.exists ? processDocData(homeDoc.data()) : {};
                collections.forEach((col, index) => { freshSiteData[col] = snapshots[index].docs.map(doc => ({ id: doc.id, ...processDocData(doc.data()) })); });
                siteData = freshSiteData;
                return siteData;
            } catch (error) { console.error("Error loading all data:", error); return null; }
        }
        
        // --- RENDER FUNCTIONS ---
        const mainContentEl = document.querySelector('main');
        const defaultLang = 'en';
        let paragraphObserver, floatingObserver, homePageObserver;

        function renderSeoTags(data) { document.querySelectorAll('meta[name="description"], meta[property^="og:"], script[type="application/ld+json"], link[rel="canonical"]').forEach(el => el.remove()); document.title = data.seoTitle || "Digital Craft"; document.documentElement.lang = data.lang || 'en'; const createMeta = (attr, key, value) => { if (value) { const meta = document.createElement('meta'); meta.setAttribute(attr, key); meta.content = value; document.head.appendChild(meta); } }; createMeta('name', 'description', data.metaDescription); createMeta('property', 'og:title', data.ogTitle || data.seoTitle); createMeta('property', 'og:description', data.ogDescription || data.metaDescription); const ogImage = data.ogImage || (data.media && data.media.length > 0 ? data.media[0] : '') || ''; if (ogImage) createMeta('property', 'og:image', ogImage); const canonical = document.createElement('link'); canonical.rel = 'canonical'; const canonicalBaseUrl = 'https://digital-craft-tbilisi-ge.netlify.app'; let cleanPath = window.location.pathname; if (cleanPath.length > 1 && cleanPath.endsWith('/')) { cleanPath = cleanPath.slice(0, -1); } canonical.href = canonicalBaseUrl + cleanPath; document.head.appendChild(canonical); if (data.schemaJsonLd && typeof data.schemaJsonLd === 'object' && Object.keys(data.schemaJsonLd).length > 0) { const script = document.createElement('script'); script.type = 'application/ld+json'; script.textContent = JSON.stringify(data.schemaJsonLd); document.head.appendChild(script); } }
        function formatContentHtml(content) { if (!content) return ''; let processedContent = content.replace(/\r\n/g, '\n'); const blocks = processedContent.split(/\n{2,}/); const html = blocks.map(block => { const trimmedBlock = block.trim(); if (!trimmedBlock) return ''; const youtubeRegex = /^https?:\/\/(?:www\.|m\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch?v=|watch\?.*&v=|shorts\/))([a-zA-Z0-9_-]{11}).*$/; const imageRegex = /^https?:\/\/[^<>"']+\.(?:jpg|jpeg|png|gif|webp|svg)\s*$/i; const youtubeMatch = trimmedBlock.match(youtubeRegex); const imageMatch = trimmedBlock.match(imageRegex); if (/^<(p|div|h[1-6]|ul|ol|li|blockquote|hr|table|pre)/i.test(trimmedBlock)) { return trimmedBlock; } else if (youtubeMatch && youtubeMatch[1]) { return `<div class="embedded-video" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; margin: 1.5em 0; border-radius: 4px; border: 1px solid var(--color-border);"><iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" src="https://www.youtube.com/embed/${youtubeMatch[1]}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`; } else if (imageMatch) { return `<p style="margin: 1.5em 0;"><img src="${trimmedBlock}" alt="Embedded content" style="max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: 4px; border: 1px solid var(--color-border);" /></p>`; } else { return `<p>${trimmedBlock.replace(/\n/g, '<br>')}</p>`; } }).join(''); return html; }
        
        function renderHomePage() { mainContentEl.innerHTML = `<section id="hero" class="hero"></section><section id="services"></section><section id="portfolio"></section><section id="blog"></section><section id="contact"></section>`; renderSeoTags(siteData.home); renderHero(); renderSection('services', 'Our Services', siteData.services); renderSection('portfolio', 'Our Work', siteData.portfolio); renderSection('blog', 'Latest Insights', siteData.blog); renderSection('contact', 'Get in Touch', siteData.contact); initMobileSliders(); initFloatingObservers(); initHomePageObservers(); }
        function renderDetailPage(item) { mainContentEl.innerHTML = ''; if (!item) { mainContentEl.innerHTML = `<section class="detail-page-header"><h1>404 - Not Found</h1><p>The page you were looking for does not exist.</p><a href="/">Go back home</a></section>`; document.title = "404 Not Found | Digital Craft"; return; } renderSeoTags(item); const formattedContent = formatContentHtml(item.mainContent); mainContentEl.innerHTML = `<section><div class="detail-page-header"><h1 class="fade-in-up" style="animation-delay: 0.5s;">${item.h1 || ''}</h1>${item.price ? `<div class="detail-price fade-in-up" style="animation-delay: 0.7s;">${item.price}</div>` : ''}</div><div class="detail-content">${formattedContent}</div></section>`; renderRelatedPosts(item); initParagraphObservers(); }
        
        function renderRelatedPosts(currentItem) { const getCollectionNameFromId = (id) => { const prefix = id.split('-')[0]; return prefix.endsWith('y') ? prefix.replace(/y$/, 'ies') : `${prefix}s`; }; const currentCollectionName = getCollectionNameFromId(currentItem.id); const pool = [...(siteData.services || []), ...(siteData.blog || [])].map(i => ({...i, collection: getCollectionNameFromId(i.id)})); const relatedItems = pool.filter(item => item.lang === currentItem.lang && item.id !== currentItem.id).sort(() => 0.5 - Math.random()).slice(0, 3); if (relatedItems.length === 0) return; const itemsHTML = relatedItems.map(item => { const langPrefix = item.lang ? `/${item.lang}` : ''; const itemUrl = `${langPrefix}/${item.collection}/${item.urlSlug}`; return `<a href="${itemUrl}" class="item-card floating-item"><div class="item-card__image" style="background-image: url('${(item.media || []).find(url => !/youtube|vimeo/.test(url)) || ''}')"></div><div class="item-card__content"><h3>${item.title}</h3><div class="card-subtitle">${item.subtitle}</div><p>${item.description}</p></div></a>` }).join(''); const relatedSection = document.createElement('section'); relatedSection.id = 'related-posts'; relatedSection.innerHTML = `<h2 class="fade-in-up">You Might Also Like</h2><div class="item-grid">${itemsHTML}</div>`; mainContentEl.appendChild(relatedSection); initFloatingObservers(); }
        function renderMenu() { const menuEl = document.querySelector('.nav-menu'); if (!menuEl) return; const menuItems = [ { label: 'Home', href: '/' }, { label: 'Services', href: '/#services' }, { label: 'Portfolio', href: '/#portfolio' }, { label: 'Blog', href: '/#blog' }, { label: 'Contact', href: '/#contact' } ]; menuEl.innerHTML = menuItems.map(item => `<li><a href="${item.href}">${item.label}</a></li>`).join(''); }
        function renderHero() { const heroSection = document.getElementById('hero'); if (!heroSection || !siteData.home) return; const { h1, subtitle } = siteData.home; let heroContent = `<h1>${h1 || ''}</h1>`; if (subtitle) { const formattedSubtitle = formatContentHtml(subtitle); heroContent += `<div class="hero-subtitle-container">${formattedSubtitle}</div>`; } heroSection.innerHTML = heroContent; };
        function renderSection(key, title, items) { const section = document.getElementById(key); if (!section) return; const itemsFromDb = items || []; const desktopItemsHTML = itemsFromDb.map(item => { const langPrefix = item.lang ? `/${item.lang}` : ''; const itemUrl = `${langPrefix}/${key}/${item.urlSlug}`; return `<a href="${itemUrl}" class="item-card floating-item"><div class="item-card__image" style="background-image: url('${(item.media || []).find(url => !/youtube|vimeo/.test(url)) || ''}')"></div><div class="item-card__content"><h3>${item.title}</h3><div class="card-subtitle">${item.subtitle}</div><p>${item.description}</p></div></a>` }).join(''); const desktopGrid = `<div class="item-grid">${desktopItemsHTML}</div>`; const langOrder = ['en', 'ka', 'ua', 'ru']; const itemsByLang = {}; itemsFromDb.forEach(item => { if (!itemsByLang[item.lang]) itemsByLang[item.lang] = []; itemsByLang[item.lang].push(item); }); const mobileSlidersHTML = langOrder.map(lang => { const langItems = itemsByLang[lang]; if (!langItems || langItems.length === 0) return ''; const slidesHTML = langItems.map((item, index) => { const langPrefix = item.lang ? `/${item.lang}` : ''; const itemUrl = `${langPrefix}/${key}/${item.urlSlug}`; return `<a href="${itemUrl}" class="item-card ${index === 0 ? 'active' : ''}"><div class="item-card__image" style="background-image: url('${(item.media || []).find(url => !/youtube|vimeo/.test(url)) || ''}')"></div><div class="item-card__content"><h3>${item.title}</h3><div class="card-subtitle">${item.subtitle}</div><p>${item.description}</p></div></a>` }).join(''); const dotsHTML = langItems.length > 1 ? langItems.map((_, index) => `<span class="slider-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></span>`).join('') : ''; return `<div class="language-slider-block"><div class="cross-fade-slider">${slidesHTML}</div><div class="slider-nav">${dotsHTML}</div></div>`; }).join(''); const mobileContainer = `<div class="mobile-sliders-container">${mobileSlidersHTML}</div>`; section.innerHTML = `<div class="animated-container"><h2>${title}</h2></div>${desktopGrid}${mobileContainer}`; };
        
        // --- ADMIN PANEL FUNCTIONS ---
        function renderAdminPanel() { renderAdminHome(); renderAdminSection('services'); renderAdminSection('portfolio'); renderAdminSection('blog'); renderAdminSection('contact'); };
        function renderAdminHome() { const container = document.querySelector('.tab-content[data-tab-content="home"]'); if(!container || !siteData.home) return; const data = siteData.home; container.innerHTML = `<div class="admin-section-header"><h2>Home Page Content & SEO</h2></div><div class="admin-item" id="admin-home-item"><div class="admin-item-content"><h4>Visible Content</h4><label for="home-h1">Main Header (H1)</label><input type="text" id="home-h1" value="${data.h1 || ''}" disabled><label for="home-subtitle">Subtitle</label><textarea id="home-subtitle" rows="3" disabled>${data.subtitle || ''}</textarea><h4>Critical SEO</h4><label for="home-lang">Language (e.g., en, ru)</label><input type="text" id="home-lang" value="${data.lang || 'en'}" disabled><label for="home-seoTitle">SEO Title Tag</label><input type="text" id="home-seoTitle" value="${data.seoTitle || ''}" disabled><label for="home-metaDescription">Meta Description</label><textarea id="home-metaDescription" rows="3" disabled>${data.metaDescription || ''}</textarea><h4>Schema.org</h4><label>JSON-LD Code</label><textarea id="home-schemaJsonLd" rows="8" disabled>${typeof data.schemaJsonLd === 'object' ? JSON.stringify(data.schemaJsonLd, null, 2) : data.schemaJsonLd || '{}'}</textarea><h4>Open Graph</h4><label for="home-ogTitle">OG Title</label><input type="text" id="home-ogTitle" value="${data.ogTitle || ''}" disabled><label for="home-ogDescription">OG Description</label><textarea id="home-ogDescription" rows="3" disabled>${data.ogDescription || ''}</textarea><label for="home-ogImage">OG Image URL</label><input type="text" id="home-ogImage" value="${data.ogImage || ''}" disabled></div><div class="admin-item-actions"><button class="admin-btn edit-btn" data-action="edit-home">Edit</button><button class="admin-btn save-btn" data-action="save-home">Save</button></div></div>`;};
        function generateAdminItemFormHTML(item, key) { return `<div class="admin-item" data-id="${item.id}" data-key="${key}"><div class="admin-item-content"><h4>Card Content</h4><label>Card Title</label><input type="text" class="admin-input-title" value="${item.title || ''}" disabled><label>Card Subtitle / Date</label><input type="text" class="admin-input-subtitle" value="${item.subtitle || ''}" disabled><label>Card Description</label><textarea class="admin-input-description" rows="3" disabled>${item.description || ''}</textarea><h4>Detailed Page</h4><label>Language</label><select class="admin-input-lang" disabled><option value="en" ${item.lang === 'en' ? 'selected' : ''}>English (en)</option><option value="ru" ${item.lang === 'ru' ? 'selected' : ''}>Русский (ru)</option><option value="ka" ${item.lang === 'ka' ? 'selected' : ''}>Georgian (ka)</option><option value="ua" ${item.lang === 'ua' ? 'selected' : ''}>Ukrainian (ua)</option></select><label>Page URL Slug</label><input type="text" class="admin-input-urlSlug" value="${item.urlSlug || ''}" disabled><label>Page Main Header (H1)</label><input type="text" class="admin-input-h1" value="${item.h1 || ''}" disabled><label>Price / Budget</label><input type="text" class="admin-input-price" value="${item.price || ''}" disabled><label>Main Content</label><textarea class="admin-input-mainContent" rows="8" disabled>${item.mainContent || ''}</textarea><label>Media (URLs)</label><textarea class="admin-input-media" rows="4" disabled>${(item.media || []).join('\n')}</textarea><label>SEO Title Tag</label><input type="text" class="admin-input-seoTitle" value="${item.seoTitle || ''}" disabled><label>Meta Description</label><textarea class="admin-input-metaDescription" rows="3" disabled>${item.metaDescription || ''}</textarea><label>Schema.org JSON-LD</label><textarea class="admin-input-schemaJsonLd" rows="5" disabled>${typeof item.schemaJsonLd === 'object' ? JSON.stringify(item.schemaJsonLd, null, 2) : item.schemaJsonLd || '{}'}</textarea><h4>Open Graph</h4><label>OG Title</label><input type="text" class="admin-input-ogTitle" value="${item.ogTitle || ''}" disabled><label>OG Description</label><textarea class="admin-input-ogDescription" rows="2" disabled>${item.ogDescription || ''}</textarea><label>OG Image URL</label><input type="text" class="admin-input-ogImage" value="${item.ogImage || ''}" disabled></div><div class="admin-item-actions"><button class="admin-btn edit-btn" data-action="edit">Edit</button><button class="admin-btn save-btn" data-action="save">Save</button><button class="admin-btn delete-btn" data-action="delete">Delete</button></div></div>`; }
        function renderAdminSection(key) { const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`); if (!container) return; const title = key.charAt(0).toUpperCase() + key.slice(1); const items = siteData[key] || []; const langOrder = ['en', 'ka', 'ru', 'ua']; const langNames = { en: 'English', ka: 'Georgian', ru: 'Russian', ua: 'Ukrainian' }; const groupedItems = {}; items.forEach(item => { const lang = item.lang || defaultLang; if (!groupedItems[lang]) groupedItems[lang] = []; groupedItems[lang].push(item); }); const listsHTML = langOrder.map(lang => { if (!groupedItems[lang] || groupedItems[lang].length === 0) return ''; const itemsListHTML = groupedItems[lang].sort((a, b) => (a.title || '').localeCompare(b.title || '')).map(item => `<li class="admin-list-item" data-id="${item.id}" data-key="${key}">${item.title || 'No Title'}<span class="admin-list-item-slug">(/${item.urlSlug || 'no-slug'})</span></li>`).join(''); return `<div class="admin-lang-group"><h4>${langNames[lang]} (${lang})</h4><ul class="admin-item-list">${itemsListHTML}</ul></div>`; }).join(''); container.innerHTML = `<div class="admin-section-header"><h2>Manage ${title}</h2><button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button></div>${listsHTML}<div class="admin-item-editor-container"></div>`; };
        async function handleAdminActions(e) { /* Unchanged */ const target = e.target; const action = target.dataset.action; if (!action) return; const itemEl = target.closest('.admin-item'); const setEditingState = (el, isEditing) => { el.classList.toggle('is-editing', isEditing); el.querySelectorAll('input, textarea, select').forEach(input => input.disabled = !isEditing); }; try { if (action === 'edit-home') { setEditingState(itemEl, true); return; } if (action === 'save-home') { setEditingState(itemEl, false); let schemaValue = itemEl.querySelector('#home-schemaJsonLd').value; try { schemaValue = JSON.parse(schemaValue); } catch(err) { alert("Error: Invalid JSON in Schema field."); return; } const updatedData = { h1: itemEl.querySelector('#home-h1').value, subtitle: itemEl.querySelector('#home-subtitle').value, lang: itemEl.querySelector('#home-lang').value, seoTitle: itemEl.querySelector('#home-seoTitle').value, metaDescription: itemEl.querySelector('#home-metaDescription').value, schemaJsonLd: schemaValue, ogTitle: itemEl.querySelector('#home-ogTitle').value, ogDescription: itemEl.querySelector('#home-ogDescription').value, ogImage: itemEl.querySelector('#home-ogImage').value, backgroundHtml: itemEl.querySelector('#home-backgroundHtml').value, }; await db.collection('home').doc('content').update(updatedData); await loadData(); routeAndRender(); alert('Home page updated!'); return; } const key = target.dataset.key || itemEl.dataset.key; const id = itemEl ? itemEl.dataset.id : null; switch(action) { case 'edit': setEditingState(itemEl, true); break; case 'save': { setEditingState(itemEl, false); let schemaValue = itemEl.querySelector('.admin-input-schemaJsonLd').value; try { schemaValue = JSON.parse(schemaValue); } catch(err) { alert("Error: Invalid JSON in Schema field."); return; } const updatedData = { lang: itemEl.querySelector('.admin-input-lang').value, title: itemEl.querySelector('.admin-input-title').value, subtitle: itemEl.querySelector('.admin-input-subtitle').value, description: itemEl.querySelector('.admin-input-description').value, urlSlug: itemEl.querySelector('.admin-input-urlSlug').value.trim(), h1: itemEl.querySelector('.admin-input-h1').value, price: itemEl.querySelector('.admin-input-price').value, mainContent: itemEl.querySelector('.admin-input-mainContent').value, media: itemEl.querySelector('.admin-input-media').value.split('\n').map(s => s.trim()).filter(Boolean), seoTitle: itemEl.querySelector('.admin-input-seoTitle').value, metaDescription: itemEl.querySelector('.admin-input-metaDescription').value, schemaJsonLd: schemaValue, ogTitle: itemEl.querySelector('.admin-input-ogTitle').value, ogDescription: itemEl.querySelector('.admin-input-ogDescription').value, ogImage: itemEl.querySelector('.admin-input-ogImage').value }; await db.collection(key).doc(id).update(updatedData); await loadData(); routeAndRender(); alert('Item saved!'); break; } case 'delete': if (confirm('Are you sure?')) { await db.collection(key).doc(id).delete(); await loadData(); routeAndRender(); alert('Item deleted!'); } break; case 'add': const newId = `${key.slice(0, -1)}-${Date.now()}`; const newItemData = { lang: defaultLang, urlSlug: 'new-item', title: 'New Item', subtitle: '', description: '', h1: 'New Item', mainContent: '', price: '', media: [], seoTitle: 'New Item', metaDescription: '', schemaJsonLd: {}, ogTitle: '', ogDescription: '', ogImage: '' }; await db.collection(key).doc(newId).set(newItemData); await loadData(); routeAndRender(); alert('New item added.'); break; } } catch(error) { console.error("Admin action failed:", error); alert("An error occurred."); }};
        
        // --- HELPER & EVENT FUNCTIONS ---
        function applyCustomBackground(item = null) { const iframe = document.getElementById('custom-background-iframe'); const customCode = item?.backgroundHtml || siteData.home?.backgroundHtml || ''; if (customCode.trim()) { iframe.style.display = 'block'; iframe.srcdoc = customCode; } else { iframe.style.display = 'none'; iframe.srcdoc = ''; } }
        function createFloatingObserver() { return new IntersectionObserver((entries) => { entries.forEach(entry => { const target = entry.target; const isAboveViewport = entry.boundingClientRect.top < 0; if (entry.isIntersecting) { target.classList.add('is-visible'); target.classList.remove('is-above'); } else { target.classList.remove('is-visible'); if (isAboveViewport) target.classList.add('is-above'); else target.classList.remove('is-above'); } }); }, { threshold: 0, rootMargin: "-50px 0px -50px 0px" }); }
        function initParagraphObservers() { if (paragraphObserver) paragraphObserver.disconnect(); paragraphObserver = createFloatingObserver(); document.querySelectorAll(".detail-content p, .detail-content li, .detail-content div.embedded-video, .detail-content p > img, #related-posts .item-card").forEach(el => { const targetEl = el.tagName === 'IMG' ? el.parentElement : el; if (!targetEl.classList.contains('floating-item')) { targetEl.classList.add('floating-item'); } paragraphObserver.observe(targetEl); }); }
        function initFloatingObservers() { if (floatingObserver) floatingObserver.disconnect(); floatingObserver = createFloatingObserver(); document.querySelectorAll(".item-grid .item-card.floating-item").forEach(el => { floatingObserver.observe(el); }); }
        function initHomePageObservers() { if (homePageObserver) homePageObserver.disconnect(); homePageObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const animatedElements = entry.target.id === 'hero' ? entry.target.querySelectorAll('h1, .hero-subtitle-container') : entry.target.querySelectorAll('.animated-container'); if (entry.isIntersecting) { animatedElements.forEach((el, index) => { const delay = entry.target.id === 'hero' ? 0.3 + index * 0.2 : 0; el.style.animationDelay = `${delay}s`; el.classList.add('fade-in-up'); }); } else { animatedElements.forEach(el => el.classList.remove('fade-in-up')); } }); }, { threshold: 0.1 }); document.querySelectorAll('#hero, #services, #portfolio, #blog, #contact, #related-posts').forEach(section => { if(section) homePageObserver.observe(section); }); }
        function initMobileSliders() { document.querySelectorAll('.language-slider-block').forEach(sliderBlock => { const slider = sliderBlock.querySelector('.cross-fade-slider'); const slides = slider.querySelectorAll('.item-card'); const nav = sliderBlock.querySelector('.slider-nav'); const dots = nav.querySelectorAll('.slider-dot'); const updateSliderHeight = () => { const activeSlide = slider.querySelector('.item-card.active'); if (activeSlide) { slider.style.height = `${activeSlide.offsetHeight}px`; } }; if (slides.length <= 1) { setTimeout(updateSliderHeight, 100); return; } let currentIndex = 0; function goToSlide(index) { currentIndex = (index + slides.length) % slides.length; slides.forEach((s, i) => s.classList.toggle('active', i === currentIndex)); dots.forEach((d, i) => d.classList.toggle('active', i === currentIndex)); updateSliderHeight(); } updateSliderHeight(); nav.addEventListener('click', e => { if (e.target.matches('.slider-dot')) { goToSlide(parseInt(e.target.dataset.index)); } }); }); }
        async function handleAdminLogin() { if (auth.currentUser) { document.getElementById('admin-panel').classList.add('active'); return; } const email = prompt("Enter admin email:"); if (!email) return; const password = prompt("Enter admin password:"); if (!password) return; try { await auth.signInWithEmailAndPassword(email, password); document.getElementById('admin-panel').classList.add('active'); } catch (error) { console.error("Admin login failed:", error.message); alert("Login failed."); } }
        
        function handleNavigation(e) { const link = e.target.closest('a'); if (!link || link.target === '_blank' || link.protocol !== window.location.protocol || link.host !== window.location.host || e.metaKey || e.ctrlKey || e.shiftKey) { return; } const linkUrl = new URL(link.href); const isAnchorLink = !!linkUrl.hash; if (isAnchorLink && (linkUrl.pathname === window.location.pathname || linkUrl.pathname === '/')) { const targetElementId = linkUrl.hash.substring(1); const element = document.getElementById(targetElementId); if (element) { e.preventDefault(); element.scrollIntoView({ behavior: 'smooth' }); } return; } if (linkUrl.href === window.location.href) { e.preventDefault(); return; } e.preventDefault(); window.history.pushState({}, '', linkUrl.pathname + linkUrl.search + linkUrl.hash); routeAndRender(); window.scrollTo(0, 0); };
        
        function routeAndRender() {
            if (typeof ym === 'function') { ym(103413242, 'hit', window.location.href); }
            if (paragraphObserver) paragraphObserver.disconnect();
            if (floatingObserver) floatingObserver.disconnect();
            if (homePageObserver) homePageObserver.disconnect();
            const path = window.location.pathname;
            const detailPageRegex = /^\/(?:([a-z]{2})\/)?(services|portfolio|blog|contact)\/([a-zA-Z0-9-]+)\/?$/;
            const match = path.match(detailPageRegex);
            if (match) {
                const [, lang, collection, slug] = match;
                const currentLang = lang || defaultLang;
                const item = siteData[collection]?.find(d => d.urlSlug === slug && d.lang === currentLang);
                renderDetailPage(item);
            } else {
                renderHomePage();
            }
            renderAdminPanel();
            applyCustomBackground(match ? siteData[match[2]]?.find(d=>d.urlSlug===match[3]) : siteData.home);
        }

        // --- ГЛАВНАЯ ФУНКЦИЯ ЗАПУСКА ---
        async function initializeApp() {
            // Add event listeners ONCE
            document.body.addEventListener('click', handleNavigation);
            window.addEventListener('popstate', routeAndRender);
            const menuToggle = document.querySelector('.menu-toggle');
            const navOverlay = document.querySelector('.nav-overlay');
            menuToggle.addEventListener('click', (e) => { e.stopPropagation(); document.body.classList.toggle('nav-is-open'); menuToggle.classList.toggle('is-active'); navOverlay.classList.toggle('is-active'); });
            navOverlay.addEventListener('click', (e) => { const link = e.target.closest('a'); if (link || e.target === navOverlay) { document.body.classList.remove('nav-is-open'); menuToggle.classList.remove('is-active'); navOverlay.classList.remove('is-active'); } });
            document.getElementById('admin-close-btn').addEventListener('click', () => document.getElementById('admin-panel').classList.remove('active')); 
            document.querySelector('.admin-content').addEventListener('click', handleAdminActions); 
            document.querySelector('.admin-tabs').addEventListener('click', e => { if (e.target.matches('.admin-tab')) { document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.querySelector(`.tab-content[data-tab-content="${e.target.dataset.tab}"]`).classList.add('active'); } }); 
            document.getElementById('site-footer').addEventListener('click', handleAdminLogin); 
            
            try {
                await loadData();
                renderMenu();
                routeAndRender();
            } catch (error) {
                console.error("Failed to initialize app:", error);
                mainContentEl.innerHTML = `<h1>Something went wrong</h1><p>Could not load site data. Please try again later.</p>`;
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        window.addEventListener('DOMContentLoaded', initializeApp);

    </script>
    <script src="metrika.js" defer=""></script>
</body>
</html>